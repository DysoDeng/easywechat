{"version":3,"file":"assets/js/v-bfcad9c8.0ccdab2f.js","mappings":"gHAAO,MAAMA,EAAO,CAClB,IAAO,aACP,KAAQ,0BACR,MAAS,SACT,KAAQ,QACR,YAAe,GACf,QAAW,GACX,QAAW,CACT,CACE,MAAS,EACT,MAAS,MACT,KAAQ,MACR,SAAY,IAEd,CACE,MAAS,EACT,MAAS,cACT,KAAQ,cACR,SAAY,IAEd,CACE,MAAS,EACT,MAAS,SACT,KAAQ,SACR,SAAY,IAEd,CACE,MAAS,EACT,MAAS,SACT,KAAQ,SACR,SAAY,KAGhB,iBAAoB,uBACpB,IAAO,CACL,YAAe,aACf,aAAgB,M,uDCpCpB,E,SAAA,kjmBCIA,EAHe,CACf,O,qBDFA","sources":["webpack:///./.vuepress/.temp/pages/3.x/open_platform.html.js","webpack:///./.vuepress/.temp/pages/3.x/open_platform.html.vue","webpack:///./.vuepress/.temp/pages/3.x/open_platform.html.vue?3074"],"sourcesContent":["export const data = {\n  \"key\": \"v-bfcad9c8\",\n  \"path\": \"/3.x/open_platform.html\",\n  \"title\": \"微信开放平台\",\n  \"lang\": \"en-US\",\n  \"frontmatter\": {},\n  \"excerpt\": \"\",\n  \"headers\": [\n    {\n      \"level\": 3,\n      \"title\": \"实例化\",\n      \"slug\": \"实例化\",\n      \"children\": []\n    },\n    {\n      \"level\": 3,\n      \"title\": \"监听微信服务器推送事件\",\n      \"slug\": \"监听微信服务器推送事件\",\n      \"children\": []\n    },\n    {\n      \"level\": 3,\n      \"title\": \"调用 API\",\n      \"slug\": \"调用-api\",\n      \"children\": []\n    },\n    {\n      \"level\": 3,\n      \"title\": \"授权 API\",\n      \"slug\": \"授权-api\",\n      \"children\": []\n    }\n  ],\n  \"filePathRelative\": \"3.x/open_platform.md\",\n  \"git\": {\n    \"updatedTime\": 1629906046000,\n    \"contributors\": []\n  }\n}\n","<h1 id=\"微信开放平台\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#微信开放平台\" aria-hidden=\"true\">#</a> 微信开放平台</h1>\n<h3 id=\"实例化\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#实例化\" aria-hidden=\"true\">#</a> 实例化</h3>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">EasyWeChat<span class=\"token punctuation\">\\</span>Foundation<span class=\"token punctuation\">\\</span>Application</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token string single-quoted-string\">'open_platform'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string single-quoted-string\">'app_id'</span>   <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'component-app-id'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'secret'</span>   <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'component-app-secret'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'token'</span>    <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'component-token'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'aes_key'</span>  <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'component-aes-key'</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$app</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Application</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$options</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$openPlatform</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$app</span><span class=\"token operator\">-></span><span class=\"token property\">open_platform</span><span class=\"token punctuation\">;</span>\n</span></code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br><span class=\"line-number\">2</span><br><span class=\"line-number\">3</span><br><span class=\"line-number\">4</span><br><span class=\"line-number\">5</span><br><span class=\"line-number\">6</span><br><span class=\"line-number\">7</span><br><span class=\"line-number\">8</span><br><span class=\"line-number\">9</span><br><span class=\"line-number\">10</span><br><span class=\"line-number\">11</span><br><span class=\"line-number\">12</span><br><span class=\"line-number\">13</span><br><span class=\"line-number\">14</span><br><span class=\"line-number\">15</span><br><span class=\"line-number\">16</span><br></div></div><h3 id=\"监听微信服务器推送事件\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#监听微信服务器推送事件\" aria-hidden=\"true\">#</a> 监听微信服务器推送事件</h3>\n<p>公众号第三方平台推送的有四个事件：授权成功(<code>authorized</code>)，授权更新(<code>updateauthorized</code>)，授权取消（<code>unauthorized</code>），以及 <code>component_verify_ticket</code>。</p>\n<p>本 SDK 默认处理方式为：</p>\n<ul>\n<li><code>authorized</code> / <code>updateauthorized</code>: 获取授权方(Authorizer)的所有信息，并缓存 <code>authorizer_access_token</code> 和 <code>authorizer_refresh_token</code>，授权方的信息则需要开发者手动处理。</li>\n<li><code>unauthorized</code>: 删除 <code>authorizer_access_token</code> 和 <code>authorizer_refresh_token</code> 的缓存。</li>\n<li><code>component_verify_ticket</code>: 缓存 <code>component_veirfy_ticket</code>。</li>\n</ul>\n<p>当然也允许自定义处理这些事件，不过以上默认处理仍然会先执行，为的是帮助开发者免去缓存的困扰。</p>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token comment\">// 默认处理方式</span>\n<span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token property\">server</span><span class=\"token operator\">-></span><span class=\"token function\">serve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 自定义处理</span>\n<span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token property\">server</span><span class=\"token operator\">-></span><span class=\"token function\">setMessageHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 事件类型常量定义在 \\EasyWeChat\\OpenPlatform\\Guard 类里</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$event</span><span class=\"token operator\">-></span><span class=\"token property\">InfoType</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'authorized'</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// ...</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'unauthorized'</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// ...</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'updateauthorized'</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// ...</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'component_verify_ticket'</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token property\">server</span><span class=\"token operator\">-></span><span class=\"token function\">serve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 或者</span>\n<span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token property\">server</span><span class=\"token operator\">-></span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$event</span><span class=\"token operator\">-></span><span class=\"token property\">InfoType</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br><span class=\"line-number\">2</span><br><span class=\"line-number\">3</span><br><span class=\"line-number\">4</span><br><span class=\"line-number\">5</span><br><span class=\"line-number\">6</span><br><span class=\"line-number\">7</span><br><span class=\"line-number\">8</span><br><span class=\"line-number\">9</span><br><span class=\"line-number\">10</span><br><span class=\"line-number\">11</span><br><span class=\"line-number\">12</span><br><span class=\"line-number\">13</span><br><span class=\"line-number\">14</span><br><span class=\"line-number\">15</span><br><span class=\"line-number\">16</span><br><span class=\"line-number\">17</span><br><span class=\"line-number\">18</span><br><span class=\"line-number\">19</span><br><span class=\"line-number\">20</span><br><span class=\"line-number\">21</span><br><span class=\"line-number\">22</span><br><span class=\"line-number\">23</span><br><span class=\"line-number\">24</span><br><span class=\"line-number\">25</span><br></div></div><h4 id=\"授权成功-授权更新\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#授权成功-授权更新\" aria-hidden=\"true\">#</a> 授权成功，授权更新</h4>\n<p>这两个事件下，SDK 默认抓取了所有授权方所有的信息，并缓存 <code>authorizer_access_token</code> 和 <code>authorizer_refresh_token</code>，授权方的信息为原微信 API 的返回结果，由开发者自行处理，比如保存到数据库。</p>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token comment\">// 自定义处理</span>\n<span class=\"token comment\">// 其中 $event 变量里有微信推送事件本身的信息，也有授权方所有的信息。</span>\n<span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token property\">server</span><span class=\"token operator\">-></span><span class=\"token function\">setMessageHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 事件类型常量定义在 \\EasyWeChat\\OpenPlatform\\Guard 类里</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$event</span><span class=\"token operator\">-></span><span class=\"token property\">InfoType</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token string single-quoted-string\">'authorized'</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\">// 授权信息，主要是 token 和授权域</span>\n            <span class=\"token variable\">$info1</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-></span><span class=\"token property\">authorization_info</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 授权方信息，就是授权方公众号的信息了</span>\n            <span class=\"token variable\">$info2</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-></span><span class=\"token property\">authorizer_info</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br><span class=\"line-number\">2</span><br><span class=\"line-number\">3</span><br><span class=\"line-number\">4</span><br><span class=\"line-number\">5</span><br><span class=\"line-number\">6</span><br><span class=\"line-number\">7</span><br><span class=\"line-number\">8</span><br><span class=\"line-number\">9</span><br><span class=\"line-number\">10</span><br><span class=\"line-number\">11</span><br><span class=\"line-number\">12</span><br></div></div><p>目前 SDK 对这两个事件的处理方式没有区别。</p>\n<h4 id=\"授权取消\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#授权取消\" aria-hidden=\"true\">#</a> 授权取消</h4>\n<p>SDK 默认处理：删除 <code>authorizer_access_token</code> 和 <code>authorizer_refresh_token</code> 的缓存。开发者可以自行处理数据库删除授权方信息等操作。</p>\n<h4 id=\"推送-component-verify-ticket\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#推送-component-verify-ticket\" aria-hidden=\"true\">#</a> 推送 component_verify_ticket</h4>\n<p>在公众号第三方平台创建审核通过后，微信服务器会向其“授权事件接收URL”每隔10分钟定时推送 <code>component_verify_ticket</code>。SDK 内部已实现缓存 <code>component_veirfy_ticket</code>，无需开发者另行缓存。</p>\n<p>注：需要在URL路由中写上触发代码，并且注册路由后需要等待微信服务器推送 <code>component_verify_ticket</code>，才能进行后续操作，否则报&quot;Component verify ticket does not exists.&quot;</p>\n<h3 id=\"调用-api\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#调用-api\" aria-hidden=\"true\">#</a> 调用 API</h3>\n<h4 id=\"设置授权方的-app-id\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#设置授权方的-app-id\" aria-hidden=\"true\">#</a> 设置授权方的 App Id</h4>\n<p>开发者必须设置授权方来调用 API。</p>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token variable\">$openPlatform</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Application</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$options</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token property\">open_platform</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 加载授权方信息，比如 $authorizer = Authorizer::find($id);</span>\n<span class=\"token variable\">$authorizerAppId</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$authorizer</span><span class=\"token operator\">-></span><span class=\"token property\">app_id</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$authorizerRefreshToken</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$authorizer</span><span class=\"token operator\">-></span><span class=\"token property\">refresh_token</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$app</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token function\">createAuthorizerApplication</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$authorizerAppId</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$authorizerRefreshToken</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 然后调用方法和普通调用一致。</span>\n<span class=\"token comment\">// ...</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br><span class=\"line-number\">2</span><br><span class=\"line-number\">3</span><br><span class=\"line-number\">4</span><br><span class=\"line-number\">5</span><br><span class=\"line-number\">6</span><br><span class=\"line-number\">7</span><br><span class=\"line-number\">8</span><br><span class=\"line-number\">9</span><br></div></div><h3 id=\"授权-api\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#授权-api\" aria-hidden=\"true\">#</a> 授权 API</h3>\n<h4 id=\"获取预授权网址\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#获取预授权网址\" aria-hidden=\"true\">#</a> 获取预授权网址</h4>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token comment\">// 直接跳转</span>\n<span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token property\">pre_auth</span><span class=\"token operator\">-></span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'https://domain.com/callback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 获取跳转的链接</span>\n<span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token function\">getTargetUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br><span class=\"line-number\">2</span><br><span class=\"line-number\">3</span><br><span class=\"line-number\">4</span><br><span class=\"line-number\">5</span><br></div></div><p>用户授权后会带上 <code>code</code> 跳转到 <code>redirect</code> 指定的链接。</p>\n<h4 id=\"使用授权码换取公众号的接口调用凭据和授权信息\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#使用授权码换取公众号的接口调用凭据和授权信息\" aria-hidden=\"true\">#</a> 使用授权码换取公众号的接口调用凭据和授权信息</h4>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token comment\">// 使用授权码换取公众号的接口调用凭据和授权信息</span>\n<span class=\"token comment\">// Optional: $authorizationCode 不传值时会自动获取 URL 中 auth_code 值</span>\n<span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token function\">getAuthorizationInfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$authorizationCode</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br><span class=\"line-number\">2</span><br><span class=\"line-number\">3</span><br></div></div><h4 id=\"获取授权方的公众号帐号基本信息\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#获取授权方的公众号帐号基本信息\" aria-hidden=\"true\">#</a> 获取授权方的公众号帐号基本信息</h4>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token function\">getAuthorizerInfo</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$authorizerAppId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br></div></div><h4 id=\"获取授权方的选项设置信息\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#获取授权方的选项设置信息\" aria-hidden=\"true\">#</a> 获取授权方的选项设置信息</h4>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token function\">getAuthorizerOption</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$authorizerAppId</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$optionName</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br></div></div><h4 id=\"设置授权方的选项信息\" tabindex=\"-1\"><a class=\"header-anchor\" href=\"#设置授权方的选项信息\" aria-hidden=\"true\">#</a> 设置授权方的选项信息</h4>\n<div class=\"language-php ext-php line-numbers-mode\"><pre v-pre class=\"language-php\"><code><span class=\"token variable\">$openPlatform</span><span class=\"token operator\">-></span><span class=\"token function\">setAuthorizerOption</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$authorizerAppId</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$optionName</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$optionValue</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre><div class=\"line-numbers\"><span class=\"line-number\">1</span><br></div></div>","import { render } from \"./open_platform.html.vue?vue&type=template&id=01d659ba\"\nconst script = {}\nscript.render = render\n\nexport default script"],"names":["data"],"sourceRoot":""}